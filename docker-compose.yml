services:
  mongodb:
    image: mongo:7.0
    container_name: mongodb
    restart: always
    command:
      - /bin/bash
      - -c
      - |
        set -e
        mongod --replSet rs0 --bind_ip_all --logpath /var/log/mongod.log --fork
        sleep 3
        # Wait for MongoDB to start
        for i in {1..30}; do
          if mongosh --quiet --eval "db.adminCommand('ping')" mongodb://localhost:27017/admin >/dev/null 2>&1; then
            echo "✓ MongoDB is running"
            break
          fi
          sleep 1
        done
        # Initialize replica set FIRST (required before creating users)
        mongosh --quiet --eval "
          try {
            if (rs.status().ok !== 1) {
              rs.initiate({
                _id: 'rs0',
                members: [
                  { _id: 0, host: '127.0.0.1:27017' }
                ]
              });
              console.log('✓ Replica set initialized');
              sleep(2000);
            } else {
              console.log('✓ Replica set already exists');
            }
          } catch(e) {
            console.log('Initiating replica set:', e.message);
            rs.initiate({
              _id: 'rs0',
              members: [
                { _id: 0, host: '127.0.0.1:27017' }
              ]
            });
            console.log('✓ Replica set initialized');
            sleep(2000);
          }
        " mongodb://localhost:27017/admin
        # Create admin user AFTER replica set is primary
        mongosh --quiet --eval "
          try {
            db.getSiblingDB('admin').createUser({
              user: 'admin',
              pwd: 'admin123',
              roles: [{role: 'root', db: 'admin'}]
            });
            console.log('✓ Admin user created');
          } catch(e) {
            if (e.code === 48 || e.code === 51003) {
              console.log('✓ Admin user already exists');
            } else {
              console.log('Note: Admin user creation:', e.message);
            }
          }
        " mongodb://localhost:27017/admin
        echo "✓ MongoDB setup complete"
        tail -f /var/log/mongod.log
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: vorlage
    volumes:
      - mongodb_data:/data/db
    networks:
      - vorlage-network

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vorlage-app
    restart: always
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: mongodb://admin:admin123@mongodb:27017/vorlage?authSource=admin&replicaSet=rs0
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-your-secret-key-change-in-production}
      BETTER_AUTH_URL: http://localhost:3000
      NEXT_PUBLIC_APP_URL: http://localhost:3000
    depends_on:
      - mongodb
    networks:
      - vorlage-network
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.next

volumes:
  mongodb_data:

networks:
  vorlage-network:
    driver: bridge
