// Prisma Schema for Better-Auth
// Der Database Provider wird in next.config.ts konfiguriert
// Verwende `npm run setup:db` um den Provider zu wechseln
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Better-Auth User Model
model User {
  id            String    @id @default(cuid()) @map("_id")
  name          String?
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  role          String    @default("user")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  posts         Post[]
  sessions      Session[]
  accounts      Account[]
  purchases     Purchase[]
  subscriptions Subscription[]
}

model Session {
  id        String   @id @default(cuid()) @map("_id")
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String   @id @default(cuid()) @map("_id")
  userId            String
  accountId         String
  providerId        String
  accessToken       String?
  refreshToken      String?
  idToken           String?
  expiresAt         DateTime?
  password          String?
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([providerId, accountId])
}

model Verification {
  id         String   @id @default(cuid()) @map("_id")
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// Example Post Model
model Post {
  id        String   @id @default(cuid()) @map("_id")
  title     String
  content   String?
  published Boolean  @default(false)
  author    User     @relation(fields: [authorId], references: [id])
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Stripe Product Model (now for subscriptions)
model Product {
  id                String   @id @default(cuid()) @map("_id")
  name              String
  description       String?
  features          String[] @default([]) // List of features
  price             Float    // Monthly price
  currency          String   @default("eur")
  stripePriceId     String?  @unique
  stripeProductId   String?  @unique
  active            Boolean  @default(true)
  isSubscription    Boolean  @default(true) // true for subscriptions, false for one-time
  trialPeriodDays   Int?     // Trial period in days
  billingInterval   String   @default("month") // month, year
  maxUsers          Int?     // Max users for this plan
  storageGb         Int?     // Storage in GB
  highlightFeature  String?  // Main feature to highlight
  popular           Boolean  @default(false) // Mark as "Most Popular"
  sortOrder         Int      @default(0) // Display order
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  purchases         Purchase[]
  subscriptions     Subscription[]
}

// Purchase/Order Model
model Purchase {
  id                String   @id @default(cuid()) @map("_id")
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId         String
  product           Product  @relation(fields: [productId], references: [id])
  amount            Float
  currency          String
  status            String   @default("pending") // pending, completed, failed, refunded
  stripeSessionId   String?  @unique
  stripePaymentIntent String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Subscription Model
model Subscription {
  id                     String   @id @default(cuid()) @map("_id")
  userId                 String
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId              String
  product                Product  @relation(fields: [productId], references: [id])
  stripeSubscriptionId   String   @unique
  stripeCustomerId       String
  stripePriceId          String
  status                 String   // active, canceled, past_due, unpaid, incomplete
  currentPeriodStart     DateTime
  currentPeriodEnd       DateTime
  cancelAtPeriodEnd      Boolean  @default(false)
  canceledAt             DateTime?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

// Coupon Model
model Coupon {
  id                 String   @id @default(cuid()) @map("_id")
  code               String   @unique
  stripeCouponId     String?  @unique
  name               String
  description        String?
  discountType       String   // percentage, fixed_amount
  discountValue      Float    // Percentage (e.g., 20 for 20%) or fixed amount
  currency           String?  // Only for fixed_amount discounts
  duration           String   @default("once") // once, repeating, forever
  durationInMonths   Int?     // Only for repeating duration
  maxRedemptions     Int?     // Maximum number of times this can be used
  timesRedeemed      Int      @default(0)
  active             Boolean  @default(true)
  expiresAt          DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}
